<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="coarseDataTools">
<title>Using outbreak data to estimate the relative case fatality ratio • coarseDataTools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using outbreak data to estimate the relative case fatality ratio">
<meta property="og:description" content="coarseDataTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">coarseDataTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/CFR_vignette.html">Using outbreak data to estimate the relative case fatality ratio</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using outbreak data to estimate the relative case fatality ratio</h1>
                        <h4 data-toc-skip class="author">Nicholas G
Reich</h4>
            
            <h4 data-toc-skip class="date">03 July 2023</h4>
      
      
      <div class="d-none name"><code>CFR_vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-to-the-data">Introduction to the data<a class="anchor" aria-label="anchor" href="#introduction-to-the-data"></a>
</h2>
<p>The goal of this vignette is to provide a tutorial for implementing
the case fatality ratio estimation methods available in the
coarseDataTools R package. To illustrate the methods, we will estimate a
relative case fatality ratio from a simulated outbreak dataset.</p>
</div>
<div class="section level2">
<h2 id="loading-the-data-and-the-code">Loading the data and the code<a class="anchor" aria-label="anchor" href="#loading-the-data-and-the-code"></a>
</h2>
<p>We begin by loading the package and a set of simulated data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=coarseDataTools" class="external-link">coarseDataTools</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">simulated.outbreak.deaths</span><span class="op">)</span></span></code></pre></div>
<p>The data that we have loaded is a simulated dataset with five
columns. Let’s take a peek at the dataset.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulated.outbreak.deaths</span><span class="op">[</span><span class="fl">15</span><span class="op">:</span><span class="fl">20</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    time grp    R D    N</span></span>
<span><span class="co">## 15   15   1   53 0   53</span></span>
<span><span class="co">## 16   16   1  121 0  121</span></span>
<span><span class="co">## 17   17   1  293 0  293</span></span>
<span><span class="co">## 18   18   1  731 0  731</span></span>
<span><span class="co">## 19   19   1 1613 0 1613</span></span>
<span><span class="co">## 20   20   1 3400 0 3400</span></span></code></pre>
<p>The rows index observations at a particular time and group. The
columns are defined as follows:</p>
<ul>
<li>time = the specified unit of time, <span class="math inline">\(t\)</span>, for this observation</li>
<li>grp = the covariate group, <span class="math inline">\(j\)</span>,
for this observation</li>
<li>R = the number of recovered cases observed</li>
<li>D = the number of dead cases observed</li>
<li>N = the total number of cases observed, or D + R</li>
</ul>
<p>We must perform a little bit of pre-processing on the data so that it
is ready for the analysis. Specifically, we need to define the <span class="math inline">\(T\)</span> time periods that we want to use for
analysis. To avoid (for the moment) some convergence issues associated
with small sample sizes, we will only include times where both groups
have at least 10 total cases observed.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## set minimum number of observed cases for inclusion</span></span>
<span><span class="va">min.cases</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co">## observed cases</span></span>
<span><span class="va">N.1</span> <span class="op">&lt;-</span> <span class="va">simulated.outbreak.deaths</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">60</span>, <span class="st">"N"</span><span class="op">]</span></span>
<span><span class="va">N.2</span> <span class="op">&lt;-</span> <span class="va">simulated.outbreak.deaths</span><span class="op">[</span><span class="fl">61</span><span class="op">:</span><span class="fl">120</span>, <span class="st">"N"</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## subset to run analyis on times with greater than min.cases</span></span>
<span><span class="va">first.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">N.1</span> <span class="op">&gt;</span> <span class="va">min.cases</span> <span class="op">&amp;</span> <span class="va">N.2</span> <span class="op">&gt;</span> <span class="va">min.cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">last.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">N.1</span> <span class="op">&gt;</span> <span class="va">min.cases</span> <span class="op">&amp;</span> <span class="va">N.2</span> <span class="op">&gt;</span> <span class="va">min.cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">idx.for.Estep</span> <span class="op">&lt;-</span> <span class="va">first.t</span><span class="op">:</span><span class="va">last.t</span></span>
<span></span>
<span><span class="co">## find and label the subset of times to be used for estimation routine</span></span>
<span><span class="va">new.times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">idx.for.Estep</span><span class="op">)</span></span>
<span><span class="va">simulated.outbreak.deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">simulated.outbreak.deaths</span>, new.times <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">simulated.outbreak.deaths</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">idx.for.Estep</span>, <span class="va">idx.for.Estep</span> <span class="op">+</span> <span class="fl">60</span><span class="op">)</span>, <span class="st">"new.times"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">new.times</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>If we look at the new data matrix, we can see the new variable that
we’ve made and that will be used in the analysis:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulated.outbreak.deaths</span><span class="op">[</span><span class="fl">15</span><span class="op">:</span><span class="fl">20</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    time grp    R D    N new.times</span></span>
<span><span class="co">## 15   15   1   53 0   53        NA</span></span>
<span><span class="co">## 16   16   1  121 0  121        NA</span></span>
<span><span class="co">## 17   17   1  293 0  293         1</span></span>
<span><span class="co">## 18   18   1  731 0  731         2</span></span>
<span><span class="co">## 19   19   1 1613 0 1613         3</span></span>
<span><span class="co">## 20   20   1 3400 0 3400         4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="running-an-analysis">Running an analysis<a class="anchor" aria-label="anchor" href="#running-an-analysis"></a>
</h2>
<p>We wish to fit a model to the simulated dataset that adjusts for
changing reporting rates over time and for a lag between disease onset
and death. We assume that the reporting rates for dead and recovered
cases vary by time but not by covariate <span class="math inline">\(j\)</span>. We also assume that the case fatality
ratio does not vary by time but is different for each of the <span class="math inline">\(j\)</span> covariate groups. The model formula
that adjusts for reporting rates but not the lag is <span class="math display">\[\begin{eqnarray}
\log E (D_{tj}) &amp;=&amp; \log N_{tj} + \beta_0 + \alpha_t\cdot X_t +
\gamma_j\cdot Y_j
\end{eqnarray}\]</span> where <span class="math inline">\(X_t\)</span>
and <span class="math inline">\(Y_j\)</span> are indicator variables for
<span class="math inline">\(t=2,\dots,T\)</span> and <span class="math inline">\(j=2, \dots,J\)</span>. Then, <span class="math inline">\(\gamma_j\)</span> is the log relative case
fatality ratio. The EM algorithm described in the main paper imputes the
values of <span class="math inline">\(D_{tj}\)</span> for the E-step and
uses the above equation as the M-step.</p>
<p>Before running an analysis, we need to fix a few parameters.
Specifically, we need to fix the assumed <span class="math inline">\(\eta\)</span>, or the vector of probabilities that
define the survival distribution. We will assume that it is (0, .3, .4,
.3). For example, given that a case will end up dying, there is a 40%
chance that the death will occur on the third day after disease onset.
Also, we need to set starting values for the <span class="math inline">\(\alpha\)</span> parameters in the model. We will
assume that <span class="math inline">\(\alpha_t=0\)</span> for all
<span class="math inline">\(t\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assumed.nu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="va">alpha.start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">22</span><span class="op">)</span></span></code></pre></div>
<p>That is all the set up required. We can now call the central
function, <span class="math inline">\(\tt{EMforCFR()}\)</span>, which
generates three estimates of the CFR: the na"ive, the
reporting-rate-adjusted and the lag-adjusted estimators.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfr.ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EMforCFR.html">EMforCFR</a></span><span class="op">(</span></span>
<span>  assumed.nu <span class="op">=</span> <span class="va">assumed.nu</span>,</span>
<span>  alpha.start.values <span class="op">=</span> <span class="va">alpha.start</span>, full.data <span class="op">=</span> <span class="va">simulated.outbreak.deaths</span>, verb <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  SEM.var <span class="op">=</span> <span class="cn">TRUE</span>, max.iter <span class="op">=</span> <span class="fl">100</span>, tol <span class="op">=</span> <span class="fl">1e-5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>[Note that running cfr.ests will generate warnings (many of them,
likely) but not to worry because this is due to the fact that the
likelihood uses non-integer outcomes in calculating the Poisson density
function. This is an expected behavior and is not an indication of a
problem with the routine.]</p>
<p>The function <span class="math inline">\(\tt{EMforCFR()}\)</span>
returns a list with the following components:</p>
<ul>
<li>naive.rel.cfr = the na"ive estimator for the relative CFR</li>
<li>glm.rel.cfr = the reporting-rate-adjusted estimator for the relative
CFR</li>
<li>EM.rel.cfr = the lag-adjusted estimator for the relative CFR</li>
<li>EM.rel.cfr.var = the variance for the log-scale lag-adjusted
estimator taken from the final M-step</li>
<li>EM.rel.cfr.var.SEM = the Supplemented EM algorithm variance for the
log-scale lag-adjusted estimator</li>
<li>EM.rel.cfr.chain = a vector of the EM algorithm iterates of the
lag-adjusted relative CFR estimates</li>
<li>ests = the coefficient estimates for the model</li>
<li>ests.chain.EM = a matrix with all of the coefficient estimates, at
each EM iteration</li>
<li>DM = the DM matrix from the SEM algorithm</li>
<li>DMiter = a vector showing how many iterations it took for the
variance component to converge in the SEM algorithm</li>
</ul>
<p>We are particularly interested in the following components:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfr.ests</span><span class="op">$</span><span class="va">naive.rel.cfr</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.11048</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfr.ests</span><span class="op">$</span><span class="va">glm.rel.cfr</span></span></code></pre></div>
<pre><code><span><span class="co">## factor(dat[, "grp"])2 </span></span>
<span><span class="co">##            0.06035187</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfr.ests</span><span class="op">$</span><span class="va">EM.rel.cfr</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.3370229</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfr.ests</span><span class="op">$</span><span class="va">EM.rel.cfr.var.SEM</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.008047843</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicholas G. Reich, Justin Lessler, Andrew Azman.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
